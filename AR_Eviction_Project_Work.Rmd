---
title: "DS_Project"
author: "Allison Shafer, Monica Puerto, Alison Ragan"
date: "12/02/2019"
output:
  word_document: default
  html_document: default
---

# REPEAT ALL OF YOUR EDA FOR TOP AND BOTTOM FILING RATES
# TEST DIFF. METHODS & K FOR KMEANS 

```{r setup, include=FALSE}
# call in libraries to use
suppressMessages(library(tidyverse))
suppressMessages(library(DataExplorer))
suppressMessages(library(modelr))
suppressMessages(library(lubridate))
suppressMessages(library(stringr))
suppressMessages(library(purrr))
suppressMessages(library(gganimate))
suppressMessages(library(readxl))
suppressMessages(library(tidycensus))
suppressMessages(library(rvest))
suppressMessages(library(tmap))
suppressMessages(library(spData))
suppressMessages(library(tigris))
suppressMessages(library(sf))
suppressMessages(library(gridExtra))
suppressMessages(library(corrplot))
suppressMessages(library(dplyr))
suppressMessages(library(factoextra))
suppressMessages(library(cluster))
suppressMessages(library(RColorBrewer))
suppressMessages(library(MASS))
# 11/8: Added packages "tmap", "spData", "tigris"
# install.packages("tmap")
# install.packages("spData")
# install.packages("tigris")
# 11/14: Added package "factoextra"
# install.packages("factoextra")
# install.packages("cluster")
# install.packages("RColorBrewer")
```
# Data Downloads
```{r download data - eviction dataset}
# set up a data directory if it does not exist already
# if(!file.exists("./data")) {dir.create("./data")}
# store urls needed - right click on excel symbol and select 
# copy link address
# eviction_US_all <- c("https://eviction-lab-data-downloads.s3.amazonaws.com/US/all.csv")
# check to see if URL saved to variable
# eviction_US_all
#download the csv file
# download.file(eviction_US_all, destfile = "./data/eviction_US_all.csv", mode = "wb") #this takes a bit ranges from 2-5 minutes, over bad WIFI might take 10 min
# read the csv file into R and save into dataframe
eviction_US_all <- read_csv("./data/eviction_US_all.csv")
names(eviction_US_all) <- gsub(x = names(eviction_US_all), pattern = "-", replacement = "_") 
dim(eviction_US_all)
head(eviction_US_all, 10)
```

```{r import rural urban}
# download and load urbal/rural classifications
# set up a data directory if it does not exist already
if(!file.exists("./data")) {dir.create("./data")}
# store urls needed - right click on excel symbol and select 
# copy link address
urban_rural <- c("http://www2.census.gov/geo/docs/reference/ua/County_Rural_Lookup.xlsx")
#download the .xlsx file
download.file(urban_rural, destfile = "./data/urban_rural.xlsx", mode = "wb")
#read xlsx into R
urban_rural <- read_excel(skip = 3, "./data/urban_rural.xlsx")
names(urban_rural)
# clean data set
urban_rural <- urban_rural %>%
  rename("Percent_Rural" = "2010 Census \r\nPercent Rural",
         "GEOID" = "2015 GEOID") 
# check names were updated
names(urban_rural)
# select only needed fields
urban_rural <-urban_rural %>%
  mutate(rural_flag = ifelse(round(Percent_Rural, 3) > 50, 1, 0)) %>%
  dplyr::select(GEOID, State, Percent_Rural, rural_flag) 
# view cleaned up dataset
head(urban_rural, 10)
```

```{r Webscrape US Labor Stats}
if(!file.exists("./data/labor_data")) {dir.create("./data/labor_data")}
#save url into a variable
url <- "https://www.bls.gov/lau/#tables"
#download the html content using read_html
download.file(url,destfile="./data/uslabor.html")
us_county_labor_html <- read_html("./data/uslabor.html")
#extract the xslx 
us_county_labor_html %>% 
   rvest::html_nodes("ul") %>%
        rvest::html_nodes("li") %>%
        rvest::html_nodes("a") %>%
        rvest::html_attr("href") %>%
        str_subset(".xlsx$") -> us_labor_urls
#domain
domain <- "https://www.bls.gov"
#paste domain to urls
str_c(domain,us_labor_urls) -> us_labor_urls
#only need years from 2000 to 2016
us_labor_urls[3:19] -> us_labor_2000_2016
years <- rep(2000:2016,1)
#a for loop that downloads each file
for(i in seq_along(us_labor_2000_2016)){
  download.file(us_labor_2000_2016[i],destfile = paste("./data/labor_data/",years[i],".xslx",sep=""),mode="wb")
}
#save the files pertaining to us labor
labor_files <- dir("./data/labor_data")
#create a function that downloads each url and saves it #into a dataframe
read_files <- function(x){
read_excel(path= paste("./data/labor_data/",x,sep=""),skip = 7,col_names = c("laus_code","state_fips_code","county_fips_code","county_name","year","","labor_force","employed","unemployed","unemployment_rate"),sheet = 1,na="")
}
#map the function to read each file 
map(labor_files,read_files) -> all_labor_data
#join all the US labor tables
all_labor_data %>% reduce(full_join) -> all_labor_data
```
# Data Cleaning
``` {r clean up data set}
#remove some rows that have NA in Year and remove empty column next to year
filter(all_labor_data,!is.na(year)) %>% dplyr::select(-6) -> all_labor_data
 
 
#creating a GEOID to join 
all_labor_data$GEOID <- str_c(all_labor_data$state_fips_code,all_labor_data$county_fips_code)
 
 
#change year to integer
all_labor_data$year <- as.integer(all_labor_data$year)
```

# Downloading Spatial Dataset

```{r download county spatial data}
# set up a data directory if it does not exist already
if(!file.exists("./data")) {dir.create("./data")}
#download county shapefiles
download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_county_500k.zip", destfile = "./data/county_shp.zip")
spatial_data <- "./data/county_shp.zip"
unzip(spatial_data, overwrite = TRUE, exdir = "./data/spatial/county_shp")
county_boundaries <- st_read("./data/spatial/county_shp/cb_2018_us_county_500k.shp")
county_boundaries
```
# Creating Additional Datasets From Existing Data

```{r make county dataset}
#County Table joined with 2 additional variables : rural flag and unemployment rate
eviction_county <- eviction_US_all %>%
  right_join(urban_rural, key = "GEOID") %>% 
  left_join(dplyr::select(all_labor_data,GEOID,year,unemployment_rate), by =c("GEOID" = "GEOID", "year"="year"))
         
head(eviction_county, 10)
```

```{r make state dataset}
eviction_state <- eviction_US_all %>%
  filter(nchar(GEOID) == 2)
         
head(eviction_state, 10)
```

```{r make region column}
states_regions <- as.data.frame(cbind("states"= state.name,"region"=state.region))#creating state and region table
#recode regions
region_names <- c("1" = "Northeast", "2" = "South", "3" = "North Central","4"="West")
recode(states_regions$region, !!!region_names) -> states_regions$region
  
left_join(eviction_state, states_regions, by = c("name"="states")) -> eviction_state
left_join(eviction_county, states_regions,by = c("parent_location"="states")) -> eviction_county
```

```{r make pct_non_white column for county}
eviction_county$pct_nonwhite <- 100 - eviction_county$pct_white
```

# Data Exploration

```{r Chunk Nulls Exploration}
#We have 22.5% missing of eviction rate data in county and 11% missing in state. ALl 
missing_state <- plot_missing(eviction_state)
missing_eviction <- plot_missing(eviction_county)
#colSums(is.na(eviction_state))/nrow(eviction_state)
#colSums(is.na(eviction_county))/nrow(eviction_county)
grid.arrange(missing_state,missing_eviction,ncol=2)
```

```{r Check if any states missing Evictions}
eviction_state %>% group_by(GEOID,name) %>% summarise_at(c("eviction_filings", "evictions"), sum, na.rm = TRUE) %>% filter(evictions != 0)
```

```{r Correlation Matrix}
#plot_correlation(na.omit(eviction_county), maxcat = 5L)
na.omit(eviction_county) %>%
select_if(is.numeric) %>%
  as.matrix() %>% cor()  -> cor_matrix
corrplot(cor_matrix[,1:nrow(cor_matrix)][1:nrow(cor_matrix),21, drop=FALSE], cl.pos='n',cl.ratio = .2, method = "number", tl.srt = 45,tl.col = "black")
#corrplot(cor_matrix, type="upper", order="hclust", sig.level = 0.01, insig = "blank")
```

```{r data exploration, echo = false, eval = false}
#look at col names
colnames(eviction_US_all)
#look at summary of data
summary(eviction_US_all)
summary(all_labor_data)
```

```{r EDA county - eviction rate}
# get top 100 counties with highest average evistion rate
eviction_county %>%
  group_by(GEOID) %>%
  summarise(
    avg_rate = mean(eviction_filing_rate, na.rm = TRUE)
  ) %>%
  top_n(100) %>%
  arrange(desc(avg_rate))
# histogram of eviction rates in county dataset
eviction_county %>%
  group_by(eviction_filing_rate) %>%
  count() %>%
  ggplot(aes(eviction_filing_rate)) +
  geom_histogram()
```

```{r Distribution of Variables, eval=FALSE}
eviction_county %>%
  dplyr::select(-year,-eviction_filings, -evictions,-imputed, -low_flag,-subbed) %>% 
  keep(is.numeric) %>%                     # Keep only numeric columns
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +                     # Plot the values
    facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_density() 
```

```{r EDA state level data}
# look at dataset
names(eviction_state)
summary(eviction_state)
# look at 2016 
eviction_state %>%
  filter(year == 2016) %>%
  ggplot(aes(x = name, y = poverty_rate)) +
  geom_bar(stat = 'identity') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip()
```

```{r EDA county level data}
# look at data set
eviction_county %>%
  group_by(GEOID) 
ncol(eviction_county)
summary(eviction_county)
glimpse(eviction_county)
```

```{r gganimate eviction for state}

# look at eviction rate over time per state -- create gganimate
# this needs to have better formatting for final.

eviction_state$fact_name <- factor(eviction_state$name, levels=rev(unique(eviction_state$name)))

eviction_state %>%
  ggplot(aes(x = eviction_filing_rate, y = fact_name)) +
  geom_point(aes(size = population, fill = rent_burden),
             shape = 21) +
  scale_x_log10(breaks = 2^(-1:7)*1000) +
  scale_size(range = c(1, 20), guide = FALSE) +
  labs(x = "Eviction Rate",
       y = "State") +
  transition_states(year, transition_length = 1,
                    state_length = 1)+
  ggtitle("Year showing {closest_state}",
          subtitle = "Frame {frame} of {nframes}")+
  theme_bw()
```

```{r gganimate eviction for county}

# look at eviction rate over time per top 25 counties -- create gganimate
# this needs to have better formatting for final.

# get top 25 counties with highest average evistion rate
county_top25_eviction <- eviction_county %>%
  group_by(GEOID) %>%
  summarise(
    avg_rate = mean(eviction_filing_rate, na.rm = TRUE)
  ) %>%
  top_n(25) %>%
  arrange(desc(avg_rate))

top25_counties <- county_top25_eviction %>%
  left_join(eviction_county, by = "GEOID") %>%
  dplyr::select(everything())

top25_counties

top25_counties$full_name <- str_c(tools::toTitleCase(top25_counties$name), top25_counties$parent_location, sep = ", ")
top25_counties <- top25_counties[order(top25_counties$full_name),]
top25_counties$full_name <- factor(top25_counties$full_name, levels=rev(unique(top25_counties$full_name)))

top25_counties %>%
  ggplot(aes(x = eviction_filing_rate, y = full_name)) +
  geom_point(aes(size = population, fill = rent_burden),
             shape = 21) +
  scale_x_log10(breaks = 2^(-1:7)*1000) +
  scale_size(range = c(1, 20), guide = FALSE) +
  labs(x = "Eviction Filing Rate",
       y = "County") +
  transition_states(year, transition_length = 1,
                    state_length = 1)+
  ggtitle("Year showing {closest_state}",
          subtitle = "Frame {frame} of {nframes}")+
  theme_bw()
```


# Set up Spatial Datasets for Mapping
```{r set up spatial datasets, eval=FALSE}
# get Census TIGER shapefiles for state
state_us_geo <- tigris::states(class= "sf")
# add spatial data to the state level eviction data
eviction_by_state <- eviction_state %>%
                       left_join(state_us_geo, c("GEOID" = "GEOID"))
eviction_by_state
# add spatial data to the county level eviction data
eviction_by_county <- eviction_county %>%
                      left_join(county_boundaries, c("GEOID" = "GEOID"))
eviction_by_county
```

```{r}
# only using data from 2010 onward to avoid issues with missing data/nulls
eviction_county_2010 <- eviction_county %>%
  filter(year >= 2010) %>%
  mutate(rural_flag = as.character(rural_flag))
eviction_county_2010$region[eviction_county_2010$name == "District of Columbia"] <- "South"
# load color palette
spectral <- c(brewer.pal(11, "Spectral"))
```

```{r trends_all}
# top and bottom 20 overall counties -- colored by region
# Calculate mean filing rate and remove any with missing data over time, or any with an avg rate less than 0.01
ecplot <- eviction_county_2010 %>%
  group_by(GEOID) %>% 
  mutate(avg_ev_fl_rate = mean(eviction_filing_rate, na.rm=TRUE)) %>% 
  filter(avg_ev_fl_rate >= 0.01) %>%
  filter(State != "AK" & State != "HI") 

# Create column for county + state
ecplot$County <- str_c(tools::toTitleCase(ecplot$name), ecplot$State, sep = ", ")

# functions to calculate top/bottom rates
calc_top <- function(df, n) {
  df <- df %>%
    group_by(GEOID) %>%
    arrange(desc(avg_ev_fl_rate)) 
  result <- c(unique(df$GEOID))[1:n]
  return(result)
}
calc_bot <- function(df, n) {
  df <- df %>%
    group_by(GEOID) %>%
    arrange(avg_ev_fl_rate)
  result <- c(unique(df$GEOID))[1:n]
  return(result)
}

top_ec <- calc_top(df=ecplot, n=10)
bot_ec <- calc_bot(df=ecplot, n=10)

# functions to plot trend over time
plot_time <- function(df, vlist, hl) {
  df %>% 
  filter(GEOID %in% vlist) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = paste(hl, "Filing Counties Over Time"),
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()
}
top_filers <- plot_time(ecplot, top_ec, "Highest")
ggsave("./fig/top_filers.png")
bot_filers <- plot_time(ecplot, bot_ec, "Lowest")
ggsave("./fig/bot_filers.png")

# functions to plot trend over time -- coloring by rural flag
plot_time_rural <- function(df, vlist, hl) {
  df %>% 
  filter(GEOID %in% vlist) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = rural_flag)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = paste(hl, "Filing Counties Over Time"),
       caption = "Data from evictionlab.org") + 
  scale_color_manual(values=c(spectral[9], spectral[11])) +
  theme_bw()
}
top_filers_rural <- plot_time_rural(ecplot, top_ec, "Highest")
ggsave("./fig/top_filers_rural.png")
bot_filers_rural <- plot_time_rural(ecplot, bot_ec, "Lowest")
ggsave("./fig/bot_filers_rural.png")
```

```{r trends_region}
# Calculate top and bottom by region
calc_top_reg <- function(df, reg, n) {
  new_df <- df %>%
    filter(region == reg) %>%
    group_by(GEOID) %>%
    arrange(desc(avg_ev_fl_rate))
  res <- c(unique(new_df$GEOID))[1:n]
  return(res)
}
calc_bot_reg <- function(df, reg, n) {
  new_df <- df %>%
    filter(region == reg) %>%
    group_by(GEOID) %>%
    arrange(avg_ev_fl_rate)
  res <- c(unique(new_df$GEOID))[1:n]
  return(res)
}

top_south <- calc_top_reg(ecplot, "South", 10)
bot_south <- calc_bot_reg(ecplot, "South", 10)
top_northeast <- calc_top_reg(ecplot, "Northeast", 10)
bot_northeast <- calc_bot_reg(ecplot, "Northeast", 10)
top_north_cent <- calc_top_reg(ecplot, "North Central", 10)
bot_north_cent <- calc_bot_reg(ecplot, "North Central", 10)
top_west <- calc_top_reg(ecplot, "West", 10)
bot_west <- calc_bot_reg(ecplot, "West", 10)


# Plot top and bottom counties by region
reg_plot <- function(df, reglist, hv, reg) {
  df %>%
    filter(GEOID %in% reglist) %>%
    ggplot() +
    geom_line(aes(x = year,
                  y = eviction_filing_rate,
                  group = GEOID,
                  color = County)) +
    xlab("Year") + 
    ylab("Eviction Filing Rates") + 
    theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = paste(hv, "Filing", reg, "Counties"),
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()
}

tplot_south <- reg_plot(ecplot, top_south, "Highest", "South")
ggsave("./fig/top_filers_south.png")
bplot_south <- reg_plot(ecplot, bot_south, "Lowest", "South")
ggsave("./fig/bot_filers_south.png")
tplot_northeast <- reg_plot(ecplot, top_northeast, "Highest", "Northeast")
ggsave("./fig/top_filers_northeast.png")
bplot_northeast <- reg_plot(ecplot, bot_northeast, "Lowest", "Northeast")
ggsave("./fig/bot_filers_northeast.png")
tplot_north_cent <- reg_plot(ecplot, top_north_cent, "Highest", "North Central")
ggsave("./fig/top_filers_north_cent.png")
bplot_north_cent <- reg_plot(ecplot, bot_north_cent, "Lowest", "North Central")
ggsave("./fig/bot_filers_north_cent.png")
tplot_west <- reg_plot(ecplot, top_west, "Highest", "West")
ggsave("./fig/top_filers_west.png")
bplot_west <- reg_plot(ecplot, bot_west, "Lowest", "West")
ggsave("./fig/bot_filers_west.png")


grid.arrange(tplot_south, tplot_northeast, tplot_north_cent, tplot_west)
g <- arrangeGrob(tplot_south, tplot_northeast, tplot_north_cent, tplot_west)
ggsave(file="./fig/tplot_region.png", g)
grid.arrange(bplot_south, bplot_northeast, bplot_north_cent, bplot_west)
g <- arrangeGrob(bplot_south, bplot_northeast, bplot_north_cent, bplot_west)
ggsave(file="./fig/bplot_region.png", g)
```

```{r trends_region_rural}
# Plot top and bottom counties by region
reg_plot_rural <- function(df, reglist, hv, reg) {
  df %>%
    filter(GEOID %in% reglist) %>%
    ggplot() +
    geom_line(aes(x = year,
                  y = eviction_filing_rate,
                  group = GEOID,
                  color = rural_flag)) +
    xlab("Year") + 
    ylab("Eviction Filing Rates") + 
    theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = paste(hv, "Filing", reg, "Counties"),
       caption = "Data from evictionlab.org") + 
  scale_color_manual(values=c(spectral[9], spectral[11])) +
  theme_bw()
}

tplot_south_rural <- reg_plot_rural(ecplot, top_south, "Highest", "South")
ggsave("./fig/tplot_south_rural.png")
bplot_south_rural <- reg_plot_rural(ecplot, bot_south, "Lowest", "South")
ggsave("./fig/bplot_south_rural.png")
tplot_northeast_rural <- reg_plot_rural(ecplot, top_northeast, "Highest", "Northeast")
ggsave("./fig/tplot_northeast_rural.png")
bplot_northeast_rural <- reg_plot_rural(ecplot, bot_northeast, "Lowest", "Northeast")
ggsave("./fig/bplot_northeast_rural.png")
tplot_north_cent_rural <- reg_plot_rural(ecplot, top_north_cent, "Highest", "North Central")
ggsave("./fig/tplot_north_cent_rural.png")
bplot_north_cent_rural <- reg_plot_rural(ecplot, bot_north_cent, "Lowest", "North Central")
ggsave("./fig/bplot_north_cent_rural.png")
tplot_west_rural <- reg_plot_rural(ecplot, top_west, "Highest", "West")
ggsave("./fig/tplot_west_rural.png")
bplot_west_rural <- reg_plot_rural(ecplot, bot_west, "Lowest", "West")
ggsave("./fig/bplot_west_rural.png")


grid.arrange(tplot_south_rural, tplot_northeast_rural, tplot_north_cent_rural, tplot_west_rural)
g <- arrangeGrob(tplot_south_rural, tplot_northeast_rural, tplot_north_cent_rural, tplot_west_rural)
ggsave(file="./fig/tplot_reg_rural.png", g)
grid.arrange(bplot_south_rural, bplot_northeast_rural, bplot_north_cent_rural, bplot_west_rural)
g <- arrangeGrob(bplot_south_rural, bplot_northeast_rural, bplot_north_cent_rural, bplot_west_rural)
ggsave(file="./fig/bplot_reg_rural.png", g)
```

```{r demos_all}
# Demographics for top and bottom
top_lists <- c(top_south, top_north_cent, top_northeast, top_west)
bot_lists <- c(bot_south, bot_north_cent, bot_northeast, bot_west)

dense_plot_demos <- function(df, id_list, demog, color_id, demo_name, qual) {
  demog <- sym(demog)
  df %>%
  filter(GEOID %in% id_list) %>%
  group_by(GEOID) %>%
  mutate(avg = (mean(!! demog, na.rm=TRUE))) %>%
  ggplot(aes(x=avg)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill=color_id) + 
  theme_bw() + 
  xlab(demo_name) + 
  ylab("Density") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = paste(demo_name, "in", qual, "Filing Counties")) 
}

top_pov <- dense_plot_demos(ecplot, top_lists, "poverty_rate", spectral[1], "Poverty Rate", "Highest")
bot_pov <- dense_plot_demos(ecplot, bot_lists, "poverty_rate", spectral[1], "Poverty Rate", "Lowest")
grid.arrange(top_pov,bot_pov)
g <- arrangeGrob(top_pov,bot_pov)
ggsave(file="./fig/pov_dist.png", g)

top_rb <- dense_plot_demos(ecplot, top_lists, "rent_burden", spectral[2], "Rent Burden", "Highest")
bot_rb <- dense_plot_demos(ecplot, bot_lists, "rent_burden", spectral[2], "Rent Burden", "Lowest")
grid.arrange(top_rb,bot_rb)
g <- arrangeGrob(top_rb,bot_rb)
ggsave(file="./fig/rb_dist.png", g)


top_pct_wh <- dense_plot_demos(ecplot, top_lists, "pct_white", spectral[3], "% White", "Highest")
bot_pct_wh <- dense_plot_demos(ecplot, bot_lists, "pct_white", spectral[3], "% White", "Lowest")
grid.arrange(top_pct_wh,bot_pct_wh)
g <- arrangeGrob(top_pct_wh,bot_pct_wh)
ggsave(file="./fig/pct_wh_dist.png", g)


top_pct_n_wh <- dense_plot_demos(ecplot, top_lists, "pct_nonwhite", spectral[4], "% Nonwhite", "Highest")
bot_pct_n_wh <- dense_plot_demos(ecplot, bot_lists, "pct_nonwhite", spectral[4], "% Nonwhite", "Lowest")
grid.arrange(top_pct_n_wh,bot_pct_n_wh)
g <- arrangeGrob(top_pct_n_wh,bot_pct_n_wh)
ggsave(file="./fig/pct_n_wh_dist.png", g)


top_hhi <- dense_plot_demos(ecplot, top_lists, "median_household_income", spectral[5], "Median Household Income", "Highest")
bot_hhi <- dense_plot_demos(ecplot, bot_lists, "median_household_income", spectral[5], "Median Household Income", "Lowest")
grid.arrange(top_hhi,bot_hhi)
g <- arrangeGrob(top_hhi,bot_hhi)
ggsave(file="./fig/hhi_dist.png", g)


top_uer <- dense_plot_demos(ecplot, top_lists, "unemployment_rate", spectral[6], "Unemployment", "Highest")
bot_uer <- dense_plot_demos(ecplot, bot_lists, "unemployment_rate", spectral[6], "Unemployment", "Lowest")
grid.arrange(top_uer,bot_uer)
g <- arrangeGrob(top_uer,bot_uer)
ggsave(file="./fig/uer_dist.png", g)


top_ro <- dense_plot_demos(ecplot, top_lists, "pct_renter_occupied", spectral[7], "% Renter Occupied", "Highest")
bot_ro <- dense_plot_demos(ecplot, bot_lists, "pct_renter_occupied", spectral[7], "% Renter Occupied", "Lowest")
grid.arrange(top_ro,bot_ro)
g <- arrangeGrob(top_ro,bot_ro)
ggsave(file="./fig/ro_dist.png", g)


top_rur <- dense_plot_demos(ecplot, top_lists, "Percent_Rural", spectral[8], "% Rural", "Highest")
bot_rur <- dense_plot_demos(ecplot, bot_lists, "Percent_Rural", spectral[8], "% Rural", "Lowest")
grid.arrange(top_rur,bot_rur)
g <- arrangeGrob(top_rur,bot_rur)
ggsave(file="./fig/rur_dist.png", g)


top_gr <- dense_plot_demos(ecplot, top_lists, "median_gross_rent", spectral[9], "Median Gross Rent", "Highest")
bot_gr <- dense_plot_demos(ecplot, bot_lists, "median_gross_rent", spectral[9], "Median Gross Rent", "Lowest")
grid.arrange(top_gr,bot_gr)
g <- arrangeGrob(top_gr,bot_gr)
ggsave(file="./fig/gr_dist.png", g)
```

```{r trends_gte_pop} 
# only include counties with populations above the mean 
ecplot_gte_mean <- ecplot %>%
  filter(population >= summary(ecplot$population)[["Mean"]])


top_ec_pop <- calc_top(ecplot_gte_mean, 10)
bot_ec_pop <- calc_bot(ecplot_gte_mean, 10)


top_filers_pop <- plot_time(ecplot_gte_mean, top_ec_pop, "Highest")
ggsave("./fig/top_filers_pop.png")
bot_filers_pop <- plot_time(ecplot_gte_mean, bot_ec_pop, "Lowest")
ggsave("./fig/bot_filers_pop.png")

top_filers_rural_pop <- plot_time_rural(ecplot_gte_mean, top_ec_pop, "Highest")
ggsave("./fig/top_filers_rural_pop.png")
bot_filers_rural_pop <- plot_time_rural(ecplot_gte_mean, bot_ec_pop, "Lowest")
ggsave("./fig/bot_filers_rural_pop.png")
```

```{r trends_regional_gte_pop}
ptop_south <- calc_top_reg(ecplot_gte_mean, "South", 10)
pbot_south <- calc_bot_reg(ecplot_gte_mean, "South", 10)
ptop_northeast <- calc_top_reg(ecplot_gte_mean, "Northeast", 10)
pbot_northeast <- calc_bot_reg(ecplot_gte_mean, "Northeast", 10)
ptop_north_cent <- calc_top_reg(ecplot_gte_mean, "North Central", 10)
pbot_north_cent <- calc_bot_reg(ecplot_gte_mean, "North Central", 10)
ptop_west <- calc_top_reg(ecplot_gte_mean, "West", 10)
pbot_west <- calc_bot_reg(ecplot_gte_mean, "West", 10)


tplot_south_pop <- reg_plot(ecplot_gte_mean, ptop_south, "Highest", "South")
ggsave("./fig/tplot_south_pop.png")
bplot_south_pop <- reg_plot(ecplot_gte_mean, pbot_south, "Lowest", "South")
ggsave("./fig/bplot_south_pop.png")
tplot_northeast_pop <- reg_plot(ecplot_gte_mean, ptop_northeast, "Highest", "Northeast")
ggsave("./fig/tplot_northeast_pop.png")
bplot_northeast_pop <- reg_plot(ecplot_gte_mean, pbot_northeast, "Lowest", "Northeast")
ggsave("./fig/bplot_northeast_pop.png")
tplot_north_cent_pop <- reg_plot(ecplot_gte_mean, ptop_north_cent, "Highest", "North Central")
ggsave("./fig/tplot_north_cent_pop.png")
bplot_north_cent_pop <- reg_plot(ecplot_gte_mean, pbot_north_cent, "Lowest", "North Central")
ggsave("./fig/bplot_north_cent_pop.png")
tplot_west_pop <- reg_plot(ecplot_gte_mean, ptop_west, "Highest", "West")
ggsave("./fig/tplot_west_pop.png")
bplot_west_pop <- reg_plot(ecplot_gte_mean, pbot_west, "Lowest", "West")
ggsave("./fig/bplot_west_pop.png")
 
grid.arrange(tplot_south_pop, tplot_northeast_pop, tplot_north_cent_pop, tplot_west_pop)
g <- arrangeGrob(tplot_south_pop, tplot_northeast_pop, tplot_north_cent_pop, tplot_west_pop)
ggsave(file="./fig/tplot_reg_pop.png", g)

grid.arrange(bplot_south_pop, bplot_northeast_pop, bplot_north_cent_pop, bplot_west_pop)
g <- arrangeGrob(bplot_south_pop, bplot_northeast_pop, bplot_north_cent_pop, bplot_west_pop)
ggsave(file="./fig/bplot_reg_pop.png", g)
```

```{r trends_regional_gte_pop_rural}
# CHECK THIS 
tplot_south_rural_pop <- reg_plot_rural(ecplot_gte_mean, ptop_south, "Highest", "South")
ggsave("./fig/tplot_south_rural_pop.png")
bplot_south_rural_pop <- reg_plot_rural(ecplot_gte_mean, pbot_south, "Lowest", "South")
ggsave("./fig/bplot_south_rural_pop.png")
tplot_northeast_rural_pop <- reg_plot_rural(ecplot_gte_mean, ptop_northeast, "Highest", "Northeast")
ggsave("./fig/tplot_northeast_rural_pop.png")
bplot_northeast_rural_pop <- reg_plot_rural(ecplot_gte_mean, pbot_northeast, "Lowest", "Northeast")
ggsave("./fig/bplot_northeast_rural_pop.png")
tplot_north_cent_rural_pop <- reg_plot_rural(ecplot_gte_mean, ptop_north_cent, "Highest", "North Central")
ggsave("./fig/tplot_north_cent_rural_pop.png")
bplot_north_cent_rural_pop <- reg_plot_rural(ecplot_gte_mean, pbot_north_cent, "Lowest", "North Central")
ggsave("./fig/bplot_north_cent_rural_pop.png")
tplot_west_rural_pop <- reg_plot_rural(ecplot_gte_mean, ptop_west, "Highest", "West")
ggsave("./fig/tplot_west_rural_pop.png")
bplot_west_rural_pop <- reg_plot_rural(ecplot_gte_mean, pbot_west, "Lowest", "West")
ggsave("./fig/bplot_west_rural_pop.png")


grid.arrange(tplot_south_rural_pop, tplot_northeast_rural_pop, tplot_north_cent_rural_pop, tplot_west_rural_pop)
g <- arrangeGrob(tplot_south_rural_pop, tplot_northeast_rural_pop, tplot_north_cent_rural_pop, tplot_west_rural_pop)
ggsave(file="./fig/tplot_reg_rur_pop.png", g)


grid.arrange(bplot_south_rural_pop, bplot_northeast_rural_pop, bplot_north_cent_rural_pop, bplot_west_rural_pop)
g <- arrangeGrob(bplot_south_rural_pop, bplot_northeast_rural_pop, bplot_north_cent_rural_pop, bplot_west_rural_pop)
ggsave(file="./fig/bplot_reg_rur_pop.png", g)
```

```{r demos_gte_pop}
# Demographics for top and bottom
ptop_lists <- c(ptop_south, ptop_north_cent, ptop_northeast, ptop_west)
pbot_lists <- c(pbot_south, pbot_north_cent, pbot_northeast, pbot_west)

ptop_pov <- dense_plot_demos(ecplot_gte_mean, ptop_lists, "poverty_rate", spectral[1], "Poverty Rate", "Highest")
pbot_pov <- dense_plot_demos(ecplot_gte_mean, pbot_lists, "poverty_rate", spectral[1], "Poverty Rate", "Lowest")
grid.arrange(ptop_pov,pbot_pov)
g <- arrangeGrob(ptop_pov,pbot_pov)
ggsave(file="./fig/pov_dist_pop.png", g)

ptop_rb <- dense_plot_demos(ecplot_gte_mean, ptop_lists, "rent_burden", spectral[2], "Rent Burden", "Highest")
pbot_rb <- dense_plot_demos(ecplot_gte_mean, pbot_lists, "rent_burden", spectral[2], "Rent Burden", "Lowest")
grid.arrange(ptop_rb,pbot_rb)
g <- arrangeGrob(ptop_rb,pbot_rb)
ggsave(file="./fig/rb_dist_pop.png", g)

ptop_pct_wh <- dense_plot_demos(ecplot_gte_mean, ptop_lists, "pct_white", spectral[3], "% White", "Highest")
pbot_pct_wh <- dense_plot_demos(ecplot_gte_mean, pbot_lists, "pct_white", spectral[3], "% White", "Lowest")
grid.arrange(ptop_pct_wh,pbot_pct_wh)
g <- arrangeGrob(ptop_pct_wh,pbot_pct_wh)
ggsave(file="./fig/pct_wh_dist_pop.png", g)


ptop_pct_n_wh <- dense_plot_demos(ecplot_gte_mean, ptop_lists, "pct_nonwhite", spectral[4], "% Nonwhite", "Highest")
pbot_pct_n_wh <- dense_plot_demos(ecplot_gte_mean, pbot_lists, "pct_nonwhite", spectral[4], "% Nonwhite", "Lowest")
grid.arrange(ptop_pct_n_wh,pbot_pct_n_wh)
g <- arrangeGrob(ptop_pct_n_wh,pbot_pct_n_wh)
ggsave(file="./fig/pct_n_wh_dist_pop.png", g)


ptop_hhi <- dense_plot_demos(ecplot_gte_mean, ptop_lists, "median_household_income", spectral[5], "Median Household Income", "Highest")
pbot_hhi <- dense_plot_demos(ecplot_gte_mean, pbot_lists, "median_household_income", spectral[5], "Median Household Income", "Lowest")
grid.arrange(ptop_hhi,pbot_hhi)
g <- arrangeGrob(ptop_hhi,pbot_hhi)
ggsave(file="./fig/hhi_dist_pop.png", g)


ptop_uer <- dense_plot_demos(ecplot_gte_mean, ptop_lists, "unemployment_rate", spectral[6], "Unemployment", "Highest")
pbot_uer <- dense_plot_demos(ecplot_gte_mean, pbot_lists, "unemployment_rate", spectral[6], "Unemployment", "Lowest")
grid.arrange(ptop_uer,pbot_uer)
g <- arrangeGrob(ptop_uer,pbot_uer)
ggsave(file="./fig/uer_dist_pop.png", g)


ptop_ro <- dense_plot_demos(ecplot_gte_mean, ptop_lists, "pct_renter_occupied", spectral[7], "% Renter Occupied", "Highest")
pbot_ro <- dense_plot_demos(ecplot_gte_mean, pbot_lists, "pct_renter_occupied", spectral[7], "% Renter Occupied", "Lowest")
grid.arrange(ptop_ro,pbot_ro)
g <- arrangeGrob(ptop_ro,pbot_ro)
ggsave(file="./fig/ro_dist_pop.png", g)


ptop_rur <- dense_plot_demos(ecplot_gte_mean, ptop_lists, "Percent_Rural", spectral[8], "% Rural", "Highest")
pbot_rur <- dense_plot_demos(ecplot_gte_mean, pbot_lists, "Percent_Rural", spectral[8], "% Rural", "Lowest")
grid.arrange(ptop_rur,pbot_rur)
g <- arrangeGrob(ptop_rur,pbot_rur)
ggsave(file="./fig/rur_dist_pop.png", g)


ptop_gr <- dense_plot_demos(ecplot_gte_mean, ptop_lists, "median_gross_rent", spectral[9], "Median Gross Rent", "Highest")
pbot_gr <- dense_plot_demos(ecplot_gte_mean, pbot_lists, "median_gross_rent", spectral[9], "Median Gross Rent", "Lowest")
grid.arrange(ptop_gr,pbot_gr)
g <- arrangeGrob(ptop_gr,pbot_gr)
ggsave(file="./fig/gr_dist_pop.png", g)
```

## K means clustering for determining similar counties

Why k-means?

- We're not trying to predict anything 
- We don't have an existing way to verify if counties are truly/correctly similar to one another

To perform a cluster analysis in R, generally, the data should be prepared as follows:

- Rows are observations (individuals) and columns are variables
- Any missing value in the data must be removed or estimated.
  - Thinking we exclude counties without any data 
- The data must be standardized (i.e., scaled) to make variables comparable

We need to make one row for each county. There are two ways to do this: 

* `group_by(GEOID)` and make each column the average of all the years 
  - this ignores how counties have changed over time
  - doesn't change the amount of variables 
* `spread_by(GEOID)` and give each column its own year (i.e. 2000 population, 2001 population, etc.)
  - results in many variables
  - kmeans can handle many, but may be extremely slow

We need to consider whether we want each year to have equal importance. 

Some weaknesses to keep in mind: 

- Requires us to pre-specify the number of clusters
- Sensitive to outliers

How to determine optimal clusters: 

1. elbow method
2. silhouette method
3. gap statistic (computationally expensive + extremely slow)

```{r kmeans_shiny}
# add filter for year for kmeans for shiny app 
# focus on base demos 
# pseudo code for app
# km <- eviction_county_2010 %>%
#   filter(year == $year) %>%
#   dplyr::select(c(GEOID, population, poverty_rate, pct_renter_occupied, median_gross_rent, median_household_income, median_property_value, rent_burden, pct_white, pct_af_am, pct_hispanic, pct_am_ind, pct_asian, pct_nh_pi, pct_multiple, pct_other, Percent_Rural, unemployment_rate, pct_nonwhite)) %>%
#   distinct() %>%
#   drop_na() %>%
#   column_to_rownames(., var = "GEOID")
# km_sc <- km
# ind <- sapply(km_sc, is.numeric)
# km_sc[ind] <- lapply(km_sc[ind], scale)
# set.seed(123)
# km3 <- kmeans(km_sc, 3, nstart = 25)
# km$cluster <- km3$cluster
# km$GEOID <- c(row.names(km))
# rownames(km) <- NULL
# km <- km %>%
#   dplyr::select(GEOID, everything())
```

```{r kmeans_avg}
km <- eviction_county_2010 %>%
  group_by(GEOID) %>%
  mutate(average_population = mean(population, na.rm = TRUE), 
         average_poverty_rate = mean(poverty_rate, na.rm = TRUE), 
         average_pct_renter_occupied = mean(pct_renter_occupied, na.rm = TRUE), 
         average_median_gross_rent = mean(median_gross_rent, na.rm = TRUE), 
         average_median_household_income = mean(median_household_income, na.rm = TRUE), 
         average_median_property_value = mean(median_property_value, na.rm = TRUE), 
         average_rent_burden = mean(rent_burden, na.rm = TRUE), 
         average_pct_white = mean(pct_white, na.rm = TRUE), 
         average_pct_af_am = mean(pct_af_am, na.rm = TRUE), 
         average_pct_hispanic = mean(pct_hispanic, na.rm = TRUE), 
         average_pct_am_ind = mean(pct_am_ind, na.rm = TRUE), 
         average_pct_asian = mean(pct_asian, na.rm = TRUE), 
         average_pct_nh_pi = mean(pct_nh_pi, na.rm = TRUE), 
         average_pct_multiple = mean(pct_multiple, na.rm = TRUE), 
         average_pct_other = mean(pct_other, na.rm = TRUE), 
         average_Percent_Rural = mean(Percent_Rural, na.rm = TRUE), 
         average_unemployment_rate = mean(unemployment_rate, na.rm = TRUE), 
         average_pct_nonwhite = mean(pct_nonwhite, na.rm = TRUE)) %>%
  filter(State != "AK" & State != "HI")
km <- subset(km, select = c("GEOID", "average_population", "average_poverty_rate", "average_pct_renter_occupied", "average_median_gross_rent", "average_median_household_income", "average_median_property_value", "average_rent_burden", "average_pct_white", "average_pct_af_am", "average_pct_hispanic", "average_pct_am_ind", "average_pct_asian", "average_pct_nh_pi", "average_pct_multiple", "average_pct_other", "average_Percent_Rural", "average_unemployment_rate", "average_pct_nonwhite" ))
# dedupe and drop nulls
km <- km %>%
  distinct() %>% # reduces to 3147
  drop_na() # reduces to 3138
# set GEOID (chr.) to index
km <- km %>%
  column_to_rownames(., var = "GEOID")
km_sc <- km
# scale numerical data
ind <- sapply(km_sc, is.numeric)
km_sc[ind] <- lapply(km_sc[ind], scale)
# determine optimal clusters 
# elbow 
set.seed(123)
fviz_nbclust(km_sc, kmeans, method = "wss") # 3
# silhouette
fviz_nbclust(km_sc, kmeans, method = "silhouette") # 3
# Results
# Compute k-means clustering
# play around with methods and k amounts 
set.seed(123)
# # Hartigan-Wong
hw_km3 <- kmeans(km_sc, 3, nstart = 25, algorithm = "Hartigan-Wong")
hw_km4 <- kmeans(km_sc, 4, nstart = 25, algorithm = "Hartigan-Wong")
hw_km5 <- kmeans(km_sc, 5, nstart = 25, algorithm = "Hartigan-Wong")
hw_km6 <- kmeans(km_sc, 6, nstart = 25, algorithm = "Hartigan-Wong")
hw_km7 <- kmeans(km_sc, 7, nstart = 25, algorithm = "Hartigan-Wong")
fviz_cluster(hw_km3, data = km_sc)
fviz_cluster(hw_km4, data = km_sc)
fviz_cluster(hw_km5, data = km_sc)
fviz_cluster(hw_km6, data = km_sc)
fviz_cluster(hw_km7, data = km_sc)
# # Lloyd
# ll_km3 <- kmeans(km_sc, 3, nstart = 25, algorithm = "Lloyd")
# ll_km4 <- kmeans(km_sc, 4, nstart = 25, algorithm = "Lloyd")
# ll_km5 <- kmeans(km_sc, 5, nstart = 25, algorithm = "Lloyd")
# ll_km6 <- kmeans(km_sc, 6, nstart = 25, algorithm = "Lloyd")
# ll_km7 <- kmeans(km_sc, 7, nstart = 25, algorithm = "Lloyd")
# fviz_cluster(ll_km3, data = km_sc)
# fviz_cluster(ll_km4, data = km_sc)
# fviz_cluster(ll_km5, data = km_sc)
# fviz_cluster(ll_km6, data = km_sc)
# fviz_cluster(ll_km7, data = km_sc)
# # Forgy
# fg_km3 <- kmeans(km_sc, 3, nstart = 25, algorithm = "Forgy")
# fg_km4 <- kmeans(km_sc, 4, nstart = 25, algorithm = "Forgy")
# fg_km5 <- kmeans(km_sc, 5, nstart = 25, algorithm = "Forgy")
# fg_km6 <- kmeans(km_sc, 6, nstart = 25, algorithm = "Forgy")
# fg_km7 <- kmeans(km_sc, 7, nstart = 25, algorithm = "Forgy")
# fviz_cluster(fg_km3, data = km_sc)
# fviz_cluster(fg_km4, data = km_sc)
# fviz_cluster(fg_km5, data = km_sc)
# fviz_cluster(fg_km6, data = km_sc)
# fviz_cluster(fg_km7, data = km_sc)
# # MacQueen
# mq_km3 <- kmeans(km_sc, 3, nstart = 25, algorithm = "MacQueen")
# mq_km4 <- kmeans(km_sc, 4, nstart = 25 , algorithm = "MacQueen")
# mq_km5 <- kmeans(km_sc, 5, nstart = 25, algorithm = "MacQueen")
# mq_km6 <- kmeans(km_sc, 6, nstart = 25, algorithm = "MacQueen")
# mq_km7 <- kmeans(km_sc, 7, nstart = 25, algorithm = "MacQueen")
# fviz_cluster(mq_km3, data = km_sc)
# fviz_cluster(mq_km4, data = km_sc)
# fviz_cluster(mq_km5, data = km_sc)
# fviz_cluster(mq_km6, data = km_sc)
# fviz_cluster(mq_km7, data = km_sc)
 
# Extract clusters and add to data frame
km$hw_km3 <- hw_km3$cluster
km$hw_km4 <- hw_km4$cluster
km$hw_km5 <- hw_km5$cluster
km$hw_km6 <- hw_km6$cluster
km$hw_km7 <- hw_km7$cluster
# km$ll_km3 <- ll_km3$cluster
# km$cluster <- ll_km4$cluster
# km$ll_km5 <- ll_km5$cluster
# km$ll_km6 <- ll_km6$cluster
# km$ll_km7 <- ll_km7$cluster
# km$fg_km3 <- fg_km3$cluster
# km$fg_km4 <- fg_km4$cluster
# km$fg_km5 <- fg_km5$cluster
# km$fg_km6 <- fg_km6$cluster
# km$fg_km7 <- fg_km7$cluster
# km$mq_km3 <- mq_km3$cluster
# km$mq_km4 <- mq_km4$cluster
# km$mq_km5 <- mq_km5$cluster
# km$mq_km6 <- mq_km6$cluster
# km$mq_km7 <- mq_km7$cluster

# reintroduce GEOID as column
km$GEOID <- c(row.names(km))
# reset index
rownames(km) <- NULL
km <- km %>%
  dplyr::select(GEOID, everything())

# make table of class counts
thw_km3 <- table(km$hw_km3)
thw_km4 <- table(km$hw_km4)
thw_km5 <- table(km$hw_km5)
thw_km6 <- table(km$hw_km6)
thw_km7 <- table(km$hw_km7)
# tll_km3 <- table(km$ll_km3)
# tll_km4 <- table(km$cluster)
# tll_km5 <- table(km$ll_km5)
# tll_km6 <- table(km$ll_km6)
# tll_km7 <- table(km$ll_km7)
# tfg_km3 <- table(km$fg_km3)
# tfg_km4 <- table(km$fg_km4)
# tfg_km5 <- table(km$fg_km5)
# tfg_km6 <- table(km$fg_km6)
# tfg_km7 <- table(km$fg_km7)
# tmq_km3 <- table(km$mq_km3)
# tmq_km4 <- table(km$mq_km4)
# tmq_km5 <- table(km$mq_km5)
# tmq_km6 <- table(km$mq_km6)
# tmq_km7 <- table(km$mq_km7)

# the second and fourth 4 clusters seem to be the best options--more clusters, but less overlap
# km$cluster <- km$ll_km4 
```

```{r cluster_eda}
km$cluster <- hw_km3$cluster

geo_clust <- subset(km, select = c("GEOID", "cluster"))
eviction_county_2010 <- merge(eviction_county_2010, geo_clust)
eviction_county_2010$cluster <- as.character(eviction_county_2010$cluster)

# box plots
ggplot(data = eviction_county_2010, mapping = aes(x = cluster, y = poverty_rate)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Povery Rate by Cluster")
ggplot(data = eviction_county_2010, mapping = aes(x = cluster, y = pct_nonwhite)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% Nonwhite by Cluster")
ggplot(data = eviction_county_2010, mapping = aes(x = cluster, y = pct_white)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% White by Cluster")
ggplot(data = eviction_county_2010, mapping = aes(x = cluster, y = pct_renter_occupied)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% Renter Occupied Rate by Cluster")
ggplot(data = eviction_county_2010, mapping = aes(x = cluster, y = median_household_income)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Median Household Income by Cluster")
ggplot(data = eviction_county_2010, mapping = aes(x = cluster, y = median_gross_rent)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Median Gross Rent by Cluster")
ggplot(data = eviction_county_2010, mapping = aes(x = cluster, y = rent_burden)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Rent Burden by Cluster")
ggplot(data = eviction_county_2010, mapping = aes(x = cluster, y = Percent_Rural)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Rural Percent by Cluster")

# stacked bar chart of region in each cluster 
eviction_county_2010 %>%
  filter(!(is.na(region))) %>%
  ggplot(aes(cluster)) + 
  geom_bar(aes(fill=region), position="fill") + 
  scale_color_brewer(palette = "Spectral") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Regions by Cluster")
```

```{r}
geo_clust <- subset(km, select = c("GEOID", "cluster"))
eviction_county_2010 <- merge(eviction_county_2010, geo_clust)
eviction_county_2010$cluster <- as.character(eviction_county_2010$cluster)

# Add county name column
eviction_county_2010$county_state <- str_c(tools::toTitleCase(as.character(eviction_county_2010$name)),
                                           eviction_county_2010$parent_location, sep = ", ")

eviction_county_2010 %>%
  ggplot(aes(year, eviction_filing_rate)) + 
  geom_line(aes(x = year,
                y = eviction_filing_rate,
                group = GEOID, 
                color = cluster))
```

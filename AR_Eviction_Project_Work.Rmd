---
title: "DS_Project"
author: "Allison Shafer, Monica Puerto, Alison Ragan"
date: "12/02/2019"
output:
  word_document: default
  html_document: default
---

# REPEAT ALL OF YOUR EDA FOR TOP AND BOTTOM FILING RATES
# TEST DIFF. METHODS & K FOR KMEANS 

```{r setup, include=FALSE}

# call in libraries to use

suppressMessages(library(tidyverse))
suppressMessages(library(DataExplorer))
suppressMessages(library(modelr))
suppressMessages(library(lubridate))
suppressMessages(library(stringr))
suppressMessages(library(purrr))
suppressMessages(library(gganimate))
suppressMessages(library(readxl))
suppressMessages(library(gifski))
suppressMessages(library(tidycensus))
suppressMessages(library(rvest))
suppressMessages(library(tmap))
suppressMessages(library(spData))
suppressMessages(library(tigris))
suppressMessages(library(sf))
suppressMessages(library(gridExtra))
suppressMessages(library(corrplot))
suppressMessages(library(dplyr))
suppressMessages(library(factoextra))
suppressMessages(library(cluster))
suppressMessages(library(RColorBrewer))
suppressMessages(library(MASS))

# 11/8: Added packages "tmap", "spData", "tigris"
# install.packages("tmap")
# install.packages("spData")
# install.packages("tigris")

# 11/14: Added package "factoextra"
# install.packages("factoextra")
# install.packages("cluster")
# install.packages("RColorBrewer")
```
# Data Downloads
```{r download data - eviction dataset}

# set up a data directory if it does not exist already
# if(!file.exists("./data")) {dir.create("./data")}

# store urls needed - right click on excel symbol and select 
# copy link address
# eviction_US_all <- c("https://eviction-lab-data-downloads.s3.amazonaws.com/US/all.csv")

# check to see if URL saved to variable
# eviction_US_all

#download the csv file
# download.file(eviction_US_all, destfile = "./data/eviction_US_all.csv", mode = "wb") #this takes a bit ranges from 2-5 minutes, over bad WIFI might take 10 min

# read the csv file into R and save into dataframe
eviction_US_all <- read_csv("./data/eviction_US_all.csv")
names(eviction_US_all) <- gsub(x = names(eviction_US_all), pattern = "-", replacement = "_") 

dim(eviction_US_all)

head(eviction_US_all, 10)
```

```{r import rural urban}

# download and load urbal/rural classifications

# set up a data directory if it does not exist already
if(!file.exists("./data")) {dir.create("./data")}

# store urls needed - right click on excel symbol and select 
# copy link address
urban_rural <- c("http://www2.census.gov/geo/docs/reference/ua/County_Rural_Lookup.xlsx")

#download the .xlsx file
download.file(urban_rural, destfile = "./data/urban_rural.xlsx", mode = "wb")

#read xlsx into R
urban_rural <- read_excel(skip = 3, "./data/urban_rural.xlsx")

names(urban_rural)

# clean data set
urban_rural <- urban_rural %>%
  rename("Percent_Rural" = "2010 Census \r\nPercent Rural",
         "GEOID" = "2015 GEOID") 

# check names were updated
names(urban_rural)

# select only needed fields
urban_rural <-urban_rural %>%
  mutate(rural_flag = ifelse(round(Percent_Rural, 3) > 50, 1, 0)) %>%
  dplyr::select(GEOID, State, Percent_Rural, rural_flag) 

# view cleaned up dataset
head(urban_rural, 10)
```

```{r Webscrape US Labor Stats}
if(!file.exists("./data/labor_data")) {dir.create("./data/labor_data")}

#save url into a variable
url <- "https://www.bls.gov/lau/#tables"

#download the html content using read_html
download.file(url,destfile="./data/uslabor.html")
us_county_labor_html <- read_html("./data/uslabor.html")

#extract the xslx 
us_county_labor_html %>% 
   rvest::html_nodes("ul") %>%
        rvest::html_nodes("li") %>%
        rvest::html_nodes("a") %>%
        rvest::html_attr("href") %>%
        str_subset(".xlsx$") -> us_labor_urls

#domain
domain <- "https://www.bls.gov"

#paste domain to urls
str_c(domain,us_labor_urls) -> us_labor_urls

#only need years from 2000 to 2016
us_labor_urls[3:19] -> us_labor_2000_2016
years <- rep(2000:2016,1)

#a for loop that downloads each file
for(i in seq_along(us_labor_2000_2016)){
  download.file(us_labor_2000_2016[i],destfile = paste("./data/labor_data/",years[i],".xslx",sep=""),mode="wb")
}

#save the files pertaining to us labor
labor_files <- dir("./data/labor_data")


#create a function that downloads each url and saves it #into a dataframe
read_files <- function(x){
read_excel(path= paste("./data/labor_data/",x,sep=""),skip = 7,col_names = c("laus_code","state_fips_code","county_fips_code","county_name","year","","labor_force","employed","unemployed","unemployment_rate"),sheet = 1,na="")
}

#map the function to read each file 
map(labor_files,read_files) -> all_labor_data

#join all the US labor tables
all_labor_data %>% reduce(full_join) -> all_labor_data
```
# Data Cleaning
``` {r clean up data set}
#remove some rows that have NA in Year and remove empty column next to year
filter(all_labor_data,!is.na(year)) %>% dplyr::select(-6) -> all_labor_data
 
 
#creating a GEOID to join 
all_labor_data$GEOID <- str_c(all_labor_data$state_fips_code,all_labor_data$county_fips_code)
 
 
#change year to integer
all_labor_data$year <- as.integer(all_labor_data$year)
```

# Downloading Spatial Dataset

```{r download county spatial data}

# set up a data directory if it does not exist already
if(!file.exists("./data")) {dir.create("./data")}

#download county shapefiles
download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_county_500k.zip", destfile = "./data/county_shp.zip")

spatial_data <- "./data/county_shp.zip"

unzip(spatial_data, overwrite = TRUE, exdir = "./data/spatial/county_shp")

county_boundaries <- st_read("./data/spatial/county_shp/cb_2018_us_county_500k.shp")
county_boundaries

```
# Creating Additional Datasets From Existing Data

```{r make county dataset}
#County Table joined with 2 additional variables : rural flag and unemployment rate

eviction_county <- eviction_US_all %>%
  right_join(urban_rural, key = "GEOID") %>% 
  left_join(dplyr::select(all_labor_data,GEOID,year,unemployment_rate), by =c("GEOID" = "GEOID", "year"="year"))
         
head(eviction_county, 10)
```

```{r make state dataset}
eviction_state <- eviction_US_all %>%
  filter(nchar(GEOID) == 2)
         
head(eviction_state, 10)
```

```{r make region column}
states_regions <- as.data.frame(cbind("states"= state.name,"region"=state.region))#creating state and region table

#recode regions
region_names <- c("1" = "Northeast", "2" = "South", "3" = "North Central","4"="West")
recode(states_regions$region, !!!region_names) -> states_regions$region
  
left_join(eviction_state, states_regions, by = c("name"="states")) -> eviction_state

left_join(eviction_county, states_regions,by = c("parent_location"="states")) -> eviction_county
```

```{r make pct_non_white column for county}
eviction_county$pct_nonwhite <- 100 - eviction_county$pct_white
```

# Data Exploration

```{r Chunk Nulls Exploration}
#We have 22.5% missing of eviction rate data in county and 11% missing in state. ALl 
missing_state <- plot_missing(eviction_state)
missing_eviction <- plot_missing(eviction_county)
#colSums(is.na(eviction_state))/nrow(eviction_state)
#colSums(is.na(eviction_county))/nrow(eviction_county)
grid.arrange(missing_state,missing_eviction,ncol=2)
```

```{r Check if any states missing Evictions}
eviction_state %>% group_by(GEOID,name) %>% summarise_at(c("eviction_filings", "evictions"), sum, na.rm = TRUE) %>% filter(evictions != 0)
```

```{r Correlation Matrix}
#plot_correlation(na.omit(eviction_county), maxcat = 5L)
na.omit(eviction_county) %>%
select_if(is.numeric) %>%
  as.matrix() %>% cor()  -> cor_matrix
corrplot(cor_matrix[,1:nrow(cor_matrix)][1:nrow(cor_matrix),21, drop=FALSE], cl.pos='n',cl.ratio = .2, method = "number", tl.srt = 45,tl.col = "black")
#corrplot(cor_matrix, type="upper", order="hclust", sig.level = 0.01, insig = "blank")
```

```{r data exploration, echo = false, eval = false}
#look at col names
colnames(eviction_US_all)
#look at summary of data
summary(eviction_US_all)
summary(all_labor_data)
```

```{r EDA county - eviction rate}
# get top 100 counties with highest average evistion rate
eviction_county %>%
  group_by(GEOID) %>%
  summarise(
    avg_rate = mean(eviction_filing_rate, na.rm = TRUE)
  ) %>%
  top_n(100) %>%
  arrange(desc(avg_rate))
# histogram of eviction rates in county dataset
eviction_county %>%
  group_by(eviction_filing_rate) %>%
  count() %>%
  ggplot(aes(eviction_filing_rate)) +
  geom_histogram()
```

```{r Distribution of Variables, eval=FALSE}
eviction_county %>%
  dplyr::select(-year,-eviction_filings, -evictions,-imputed, -low_flag,-subbed) %>% 
  keep(is.numeric) %>%                     # Keep only numeric columns
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +                     # Plot the values
    facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_density() 
```

```{r EDA state level data}
# look at dataset
names(eviction_state)
summary(eviction_state)
# look at 2016 
eviction_state %>%
  filter(year == 2016) %>%
  ggplot(aes(x = name, y = poverty_rate)) +
  geom_bar(stat = 'identity') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip()
```

```{r EDA county level data}
# look at data set
eviction_county %>%
  group_by(GEOID) 
ncol(eviction_county)
summary(eviction_county)
glimpse(eviction_county)
```

```{r gganimate eviction for state, eval=FALSE}
# look at eviction rate over time per state -- create gganimate
# this needs to have better formatting for final.
eviction_state %>%
  ggplot(aes(x = eviction_filing_rate, y = name)) +
  geom_point(aes(size = population, fill = rent_burden),
             shape = 21) +
  scale_x_log10(breaks = 2^(-1:7)*1000) +
  scale_size(range = c(1, 20), guide = FALSE) +
  labs(x = "Eviction Rate",
       y = "State") +
  transition_states(year, transition_length = 1,
                    state_length = 1)+
  ggtitle("Year showing {closest_state}",
          subtitle = "Frame {frame} of {nframes}")+
  theme_bw()
```

# Set up Spatial Datasets for Mapping
```{r set up spatial datasets, eval=FALSE}
# get Census TIGER shapefiles for state
state_us_geo <- tigris::states(class= "sf")
# add spatial data to the state level eviction data
eviction_by_state <- eviction_state %>%
                       left_join(state_us_geo, c("GEOID" = "GEOID"))
eviction_by_state
# add spatial data to the county level eviction data
eviction_by_county <- eviction_county %>%
                      left_join(county_boundaries, c("GEOID" = "GEOID"))
eviction_by_county
```

```{r}
# only using data from 2010 onward to avoid issues with missing data/nulls
eviction_county_2010 <- eviction_county %>%
  filter(year >= 2010) %>%
  mutate(rural_flag = as.character(rural_flag))
```

```{r top_bot_cty_fl_trends}
# Top + Bottom 10 Eviction Filing Rates -- determined by avg from 2000 to 2016

# Calculate mean filing rate and remove any with an avg rate less than 0.01
ecplot <- eviction_county_2010 %>%
  group_by(GEOID) %>% 
  mutate(avg_ev_fl_rate = mean(eviction_filing_rate, na.rm=TRUE)) %>% 
  filter(avg_ev_fl_rate >= 0.01) %>%
  filter(State != "AK" & State != "HI") 

# Sort in descending order and grab the GEOIDs with the highest filing rates
top_ec <- ecplot %>% 
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_ec <- c(unique(top_ec$GEOID))[1:10]

# Sort in ascending order and grab the GEOIDs with the lowest filing rates
bot_ec <- ecplot %>% 
  group_by(GEOID) %>% 
  arrange(avg_ev_fl_rate)
bot_ec <- c(unique(bot_ec$GEOID))[1:10]

ecplot$County <- str_c(tools::toTitleCase(ecplot$name), ecplot$State, sep = ", ")

# Plot the top filing counties over time
ecplot %>% 
  filter(GEOID %in% top_ec) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = County, 
                color = rural_flag)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()

# Plot the lowest filing counties over time 
ecplot %>% 
  filter(GEOID %in% bot_ec) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = rural_flag)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Lowest Filing Counties Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw() # adjust y scale # do dems of top 10 and bottom 10 

# color by rural flag 
```

```{r top_filing_cty_all}
# top 20 overall counties -- colored by region
# Calculate mean filing rate and remove any with missing data over time, or any with an avg rate less than 0.01
ecplot <- eviction_county_2010 %>%
  group_by(GEOID) %>% 
  mutate(avg_ev_fl_rate = mean(eviction_filing_rate, na.rm=TRUE)) %>% 
  filter(avg_ev_fl_rate >= 0.01) %>%
  filter(State != "AK" & State != "HI") 

# Create column for county + state
ecplot$County <- str_c(tools::toTitleCase(ecplot$name), ecplot$State, sep = ", ")

# Sort in descending order and grab the GEOIDs with the highest filing rates
top_ec <- ecplot %>% 
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_ec <- c(unique(top_ec$GEOID))[1:10]

# Plot the top filing counties over time
ecplot %>% 
  filter(GEOID %in% top_ec) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()

# Top 5/10 counties, for each region (one plot == one region)
top_south <- ecplot %>%
  filter(region == "South") %>%
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_south <- c(unique(top_south$GEOID))[1:10]
top_northeast <- ecplot %>%
  filter(region == "Northeast") %>%
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_northeast <- c(unique(top_northeast$GEOID))[1:10]
top_north_central <- ecplot %>%
  filter(region == "North Central") %>%
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_north_central <- c(unique(top_north_central$GEOID))[1:10]
top_west <- ecplot %>%
  filter(region == "West") %>%
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_west <- c(unique(top_west$GEOID))[1:10]

plot_south <- ecplot %>% 
  filter(GEOID %in% top_south) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties in the South Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()

plot_northeast <- ecplot %>% 
  filter(GEOID %in% top_northeast) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties in the Northeast Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()

plot_north_central <- ecplot %>% 
  filter(GEOID %in% top_north_central) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties in the North Central Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()

plot_west <- ecplot %>% 
  filter(GEOID %in% top_west) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties in the West Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()

# display all four in one plot 
top_region_total <- grid.arrange(plot_south, plot_northeast, plot_north_central, plot_west)
```

```{r pops_gte_mean} 
# only include counties with populations above the median 
# top 20 overall counties -- colored by region
ecplot_gte_mean <- ecplot %>%
  filter(population >= 95977)

# # Create column for county + state
# ecplot_gte_mean$County <- str_c(tools::toTitleCase(ecplot_gte_mean$name), ecplot_gte_mean$State, sep = ", ")

# Sort in descending order and grab the GEOIDs with the highest filing rates
top_ec <- ecplot_gte_mean %>% 
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_ec <- c(unique(top_ec$GEOID))[1:10]

# Plot the top filing counties over time
ecplot_gte_mean %>% 
  filter(GEOID %in% top_ec) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()

# Top 5/10 counties, for each region (one plot == one region)
top_south_gte_mean <- ecplot_gte_mean %>%
  filter(region == "South") %>%
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_south_gte_mean <- c(unique(top_south_gte_mean$GEOID))[1:10]
top_northeast_gte_mean <- ecplot_gte_mean %>%
  filter(region == "Northeast") %>%
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_northeast_gte_mean <- c(unique(top_northeast_gte_mean$GEOID))[1:10]
top_north_central_gte_mean <- ecplot_gte_mean %>%
  filter(region == "North Central") %>%
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_north_central_gte_mean <- c(unique(top_north_central_gte_mean$GEOID))[1:10]
top_west_gte_mean <- ecplot_gte_mean %>%
  filter(region == "West") %>%
  group_by(GEOID) %>% 
  arrange(desc(avg_ev_fl_rate))
top_west_gte_mean <- c(unique(top_west_gte_mean$GEOID))[1:10]

plot_south_gte_mean <- ecplot_gte_mean %>% 
  filter(GEOID %in% top_south_gte_mean) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties in the South Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") + 
  theme_bw()

plot_northeast_gte_mean <- ecplot_gte_mean %>% 
  filter(GEOID %in% top_northeast_gte_mean) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties in the Northeast Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") + 
  theme_bw()

plot_north_central_gte_mean <- ecplot_gte_mean %>% 
  filter(GEOID %in% top_north_central_gte_mean) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties in the North Central Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") + 
  theme_bw()

plot_west_gte_mean <- ecplot_gte_mean %>% 
  filter(GEOID %in% top_west_gte_mean) %>% 
  ggplot() +
  geom_line(aes(x = year, 
                y = eviction_filing_rate, 
                group = GEOID, 
                color = County)) +
  xlab("Year") +
  ylab("Eviction Filing Rates") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Top Filing Counties in the West Over Time",
       caption = "Data from evictionlab.org") + 
  scale_color_brewer(palette = "Spectral") +
  theme_bw()

# display all four in one plot 
top_region_pop <- grid.arrange(plot_south_gte_mean, plot_northeast_gte_mean, plot_north_central_gte_mean, plot_west_gte_mean)
```

```{r demos_top_gte_mean_density}
# do again for bottom
# poverty distribution 
ecplot_gte_mean %>%
  filter(GEOID %in% top_south_gte_mean | GEOID %in% top_north_central_gte_mean | GEOID %in% top_northeast_gte_mean | GEOID %in% top_west_gte_mean) %>%
  group_by(GEOID) %>%
  mutate(avg_pov = mean(poverty_rate, na.rm=TRUE)) %>%
  ggplot(aes(x=avg_pov)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill="#9E0142") + 
  theme_bw() + 
  xlab("Poverty Rate") + 
  ylab("Density") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Poverty Rate Distribution Among Highest Eviction Filers") # +
  # xlim(0,100)

# rent burden distribution 
ecplot_gte_mean %>%
  filter(GEOID %in% top_south_gte_mean | GEOID %in% top_north_central_gte_mean | GEOID %in% top_northeast_gte_mean | GEOID %in% top_west_gte_mean) %>%
  group_by(GEOID) %>%
  mutate(avg_rb = mean(rent_burden, na.rm=TRUE)) %>%
  ggplot(aes(x=avg_rb)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill="#D53E4F") + 
  theme_bw() + 
  xlab("Rent Burden") + 
  ylab("Density") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Rent Burden Distribution Among Highest Eviction Filers") # +
  # xlim(0,100)

# pct_white distribution 
ecplot_gte_mean %>%
  filter(GEOID %in% top_south_gte_mean | GEOID %in% top_north_central_gte_mean | GEOID %in% top_northeast_gte_mean | GEOID %in% top_west_gte_mean) %>%
  group_by(GEOID) %>%
  mutate(avg_pct_white = mean(pct_white, na.rm=TRUE)) %>%
  ggplot(aes(x=avg_pct_white)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill="#F46D43") + 
  theme_bw() + 
  xlab("% White") + 
  ylab("Density") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% White Distribution Among Highest Eviction Filers") # +
  # xlim(0,100)

# pct_nonwhite distribution 
ecplot_gte_mean %>%
  filter(GEOID %in% top_south_gte_mean | GEOID %in% top_north_central_gte_mean | GEOID %in% top_northeast_gte_mean | GEOID %in% top_west_gte_mean) %>%
  group_by(GEOID) %>%
  mutate(avg_pct_nonwhite = mean(pct_nonwhite, na.rm=TRUE)) %>%
  ggplot(aes(x=avg_pct_nonwhite)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill="#FDAE61") + 
  theme_bw() + 
  xlab("% Nonwhite") + 
  ylab("Density") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% Nonwhite Distribution Among Highest Eviction Filers") # +
  # xlim(0,100)

# median_household_income distribution 
ecplot_gte_mean %>%
  filter(GEOID %in% top_south_gte_mean | GEOID %in% top_north_central_gte_mean | GEOID %in% top_northeast_gte_mean | GEOID %in% top_west_gte_mean) %>%
  group_by(GEOID) %>%
  mutate(avg_med_hh = mean(median_household_income, na.rm=TRUE)) %>%
  ggplot(aes(x=avg_med_hh)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill="#FEE08B") + 
  theme_bw() + 
  xlab("Median Household Income") + 
  ylab("Density") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Median Household Income Distribution Among Highest Eviction Filers") 

# unemployment_rate distribution 
ecplot_gte_mean %>%
  filter(GEOID %in% top_south_gte_mean | GEOID %in% top_north_central_gte_mean | GEOID %in% top_northeast_gte_mean | GEOID %in% top_west_gte_mean) %>%
  group_by(GEOID) %>%
  mutate(avg_ue_rt = mean(unemployment_rate, na.rm=TRUE)) %>%
  ggplot(aes(x=avg_ue_rt)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill="#FFFFBF") + 
  theme_bw() +  
  xlab("Unemployment Rate") + 
  ylab("Density") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Unemployment Rate Distribution Among Highest Eviction Filers") # +
  # xlim(0,100)

# pct_rent_occ distribution 
ecplot_gte_mean %>%
  filter(GEOID %in% top_south_gte_mean | GEOID %in% top_north_central_gte_mean | GEOID %in% top_northeast_gte_mean | GEOID %in% top_west_gte_mean) %>%
  group_by(GEOID) %>%
  mutate(avg_pct_ro = mean(pct_renter_occupied, na.rm=TRUE)) %>%
  ggplot(aes(x=avg_pct_ro)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill="#E6F598") + 
  theme_bw() +  
  xlab("% Renter Occupied") + 
  ylab("Density") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% Renter Occupied Distribution Among Highest Eviction Filers") # +
  # xlim(0,100)

# pct_rural dist
ecplot_gte_mean %>%
  filter(GEOID %in% top_south_gte_mean | GEOID %in% top_north_central_gte_mean | GEOID %in% top_northeast_gte_mean | GEOID %in% top_west_gte_mean) %>%
  group_by(GEOID) %>%
  mutate(avg_pct_rur = mean(Percent_Rural, na.rm=TRUE)) %>%
  ggplot(aes(x=avg_pct_rur)) + 
  geom_histogram(aes(y=..density..), color="black", fill="white", bins=20) + 
  geom_density(alpha=.5, fill="#E6F598") + 
  theme_bw() +  
  xlab("% Renter Occupied") + 
  ylab("Density") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% Renter Occupied Distribution Among Highest Eviction Filers")
```

## K means clustering for determining similar counties

Why k-means?

- We're not trying to predict anything 
- We don't have an existing way to verify if counties are truly/correctly similar to one another

To perform a cluster analysis in R, generally, the data should be prepared as follows:

- Rows are observations (individuals) and columns are variables
- Any missing value in the data must be removed or estimated.
  - Thinking we exclude counties without any data 
- The data must be standardized (i.e., scaled) to make variables comparable

We need to make one row for each county. There are two ways to do this: 

* `group_by(GEOID)` and make each column the average of all the years 
  - this ignores how counties have changed over time
  - doesn't change the amount of variables 
* `spread_by(GEOID)` and give each column its own year (i.e. 2000 population, 2001 population, etc.)
  - results in many variables
  - kmeans can handle many, but may be extremely slow

We need to consider whether we want each year to have equal importance. 

Some weaknesses to keep in mind: 

- Requires us to pre-specify the number of clusters
- Sensitive to outliers

How to determine optimal clusters: 

1. elbow method
2. silhouette method
3. gap statistic
4. Use the `Nbclust` package which provides 30 indices for determining the relevant number of clusters and proposes to users the best clustering scheme from the different results obtained by varying all combinations of number of clusters, distance measures, and clustering methods.

```{r kmeans_shiny}
# add filter for year for kmeans for shiny app 
# focus on base demos 

# pseudo code for app
# km <- eviction_county_2010 %>%
#   filter(year == $year) %>%
#   dplyr::select(c(GEOID, population, poverty_rate, pct_renter_occupied, median_gross_rent, median_household_income, median_property_value, rent_burden, pct_white, pct_af_am, pct_hispanic, pct_am_ind, pct_asian, pct_nh_pi, pct_multiple, pct_other, Percent_Rural, unemployment_rate, pct_nonwhite)) %>%
#   distinct() %>%
#   drop_na() %>%
#   column_to_rownames(., var = "GEOID")
# km_sc <- km
# ind <- sapply(km_sc, is.numeric)
# km_sc[ind] <- lapply(km_sc[ind], scale)
# set.seed(123)
# km3 <- kmeans(km_sc, 3, nstart = 25)
# km$cluster <- km3$cluster
# km$GEOID <- c(row.names(km))
# rownames(km) <- NULL
# km <- km %>%
#   dplyr::select(GEOID, everything())
```

```{r kmeans_avg}
km <- eviction_county_2010 %>%
  group_by(GEOID) %>%
  mutate(average_population = mean(population, na.rm = TRUE), average_poverty_rate = mean(poverty_rate, na.rm = TRUE), average_pct_renter_occupied = mean(pct_renter_occupied, na.rm = TRUE), average_median_gross_rent = mean(median_gross_rent, na.rm = TRUE), average_median_household_income = mean(median_household_income, na.rm = TRUE), average_median_property_value = mean(median_property_value, na.rm = TRUE), average_rent_burden = mean(rent_burden, na.rm = TRUE), average_pct_white = mean(pct_white, na.rm = TRUE), average_pct_af_am = mean(pct_af_am, na.rm = TRUE), average_pct_hispanic = mean(pct_hispanic, na.rm = TRUE), average_pct_am_ind = mean(pct_am_ind, na.rm = TRUE), average_pct_asian = mean(pct_asian, na.rm = TRUE), average_pct_nh_pi = mean(pct_nh_pi, na.rm = TRUE), average_pct_multiple = mean(pct_multiple, na.rm = TRUE), average_pct_other = mean(pct_other, na.rm = TRUE), average_Percent_Rural = mean(Percent_Rural, na.rm = TRUE), average_unemployment_rate = mean(unemployment_rate, na.rm = TRUE), average_pct_nonwhite = mean(pct_nonwhite, na.rm = TRUE)) %>%
  filter(State != "AK" & State != "HI")

km <- subset(km, select = c("GEOID", "average_population", "average_poverty_rate", "average_pct_renter_occupied", "average_median_gross_rent", "average_median_household_income", "average_median_property_value", "average_rent_burden", "average_pct_white", "average_pct_af_am", "average_pct_hispanic", "average_pct_am_ind", "average_pct_asian", "average_pct_nh_pi", "average_pct_multiple", "average_pct_other", "average_Percent_Rural", "average_unemployment_rate", "average_pct_nonwhite" ))

# dedupe and drop nulls
km <- km %>%
  distinct() %>% # reduces to 3147
  drop_na() # reduces to 3138

# set GEOID (chr.) to index
km <- km %>%
  column_to_rownames(., var = "GEOID")

km_sc <- km

# scale numerical data
library(MASS)
ind <- sapply(km_sc, is.numeric)
km_sc[ind] <- lapply(km_sc[ind], scale)

# determine optimal clusters 
# elbow 
set.seed(123)
fviz_nbclust(km_sc, kmeans, method = "wss") # 3
# silhouette
fviz_nbclust(km_sc, kmeans, method = "silhouette") # 3

# Results
# Compute k-means clustering
# play around with methods and k amounts 
set.seed(123)
# Hartigan-Wong
hw_km3 <- kmeans(km_sc, 3, nstart = 25, algorithm = "Hartigan-Wong")
hw_km4 <- kmeans(km_sc, 4, nstart = 25, algorithm = "Hartigan-Wong")
hw_km5 <- kmeans(km_sc, 5, nstart = 25, algorithm = "Hartigan-Wong")
hw_km6 <- kmeans(km_sc, 6, nstart = 25, algorithm = "Hartigan-Wong")
hw_km7 <- kmeans(km_sc, 7, nstart = 25, algorithm = "Hartigan-Wong")
fviz_cluster(hw_km3, data = km_sc)
fviz_cluster(hw_km4, data = km_sc)
fviz_cluster(hw_km5, data = km_sc)
fviz_cluster(hw_km6, data = km_sc)
fviz_cluster(hw_km7, data = km_sc)
# Lloyd
ll_km3 <- kmeans(km_sc, 3, nstart = 25, algorithm = "Lloyd")
ll_km4 <- kmeans(km_sc, 4, nstart = 25, algorithm = "Lloyd")
ll_km5 <- kmeans(km_sc, 5, nstart = 25, algorithm = "Lloyd")
ll_km6 <- kmeans(km_sc, 6, nstart = 25, algorithm = "Lloyd")
ll_km7 <- kmeans(km_sc, 7, nstart = 25, algorithm = "Lloyd")
fviz_cluster(ll_km3, data = km_sc)
fviz_cluster(ll_km4, data = km_sc)
fviz_cluster(ll_km5, data = km_sc)
fviz_cluster(ll_km6, data = km_sc)
fviz_cluster(ll_km7, data = km_sc)
# Forgy
fg_km3 <- kmeans(km_sc, 3, nstart = 25, algorithm = "Forgy")
fg_km4 <- kmeans(km_sc, 4, nstart = 25, algorithm = "Forgy")
fg_km5 <- kmeans(km_sc, 5, nstart = 25, algorithm = "Forgy")
fg_km6 <- kmeans(km_sc, 6, nstart = 25, algorithm = "Forgy")
fg_km7 <- kmeans(km_sc, 7, nstart = 25, algorithm = "Forgy")
fviz_cluster(fg_km3, data = km_sc)
fviz_cluster(fg_km4, data = km_sc)
fviz_cluster(fg_km5, data = km_sc)
fviz_cluster(fg_km6, data = km_sc)
fviz_cluster(fg_km7, data = km_sc)
# MacQueen
mq_km3 <- kmeans(km_sc, 3, nstart = 25, algorithm = "MacQueen")
mq_km4 <- kmeans(km_sc, 4, nstart = 25 , algorithm = "MacQueen")
mq_km5 <- kmeans(km_sc, 5, nstart = 25, algorithm = "MacQueen")
mq_km6 <- kmeans(km_sc, 6, nstart = 25, algorithm = "MacQueen")
mq_km7 <- kmeans(km_sc, 7, nstart = 25, algorithm = "MacQueen")
fviz_cluster(mq_km3, data = km_sc)
fviz_cluster(mq_km4, data = km_sc)
fviz_cluster(mq_km5, data = km_sc)
fviz_cluster(mq_km6, data = km_sc)
fviz_cluster(mq_km7, data = km_sc)
 

# Extract clusters and add to data frame
km$cluster <- km3$cluster
# reintroduce GEOID as column
km$GEOID <- c(row.names(km))
# reset index 
rownames(km) <- NULL
km <- km %>%
  dplyr::select(GEOID, everything())
```

```{r cluster_eda}
geo_clust <- subset(km, select = c("GEOID", "cluster"))
ecp_cl <- merge(eviction_county_2010, geo_clust)
ecp_cl$cluster <- as.character(ecp_cl$cluster)
# box plots
ggplot(data = ecp_cl, mapping = aes(x = cluster, y = poverty_rate)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Povery Rate by Cluster")
ggplot(data = ecp_cl, mapping = aes(x = cluster, y = pct_nonwhite)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% Nonwhite by Cluster")
ggplot(data = ecp_cl, mapping = aes(x = cluster, y = pct_white)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% White by Cluster")
ggplot(data = ecp_cl, mapping = aes(x = cluster, y = pct_renter_occupied)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "% Renter Occupied Rate by Cluster")
ggplot(data = ecp_cl, mapping = aes(x = cluster, y = median_household_income)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Median Household Income by Cluster")
ggplot(data = ecp_cl, mapping = aes(x = cluster, y = median_gross_rent)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Median Gross Rent by Cluster")
ggplot(data = ecp_cl, mapping = aes(x = cluster, y = rent_burden)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Rent Burden by Cluster")
ggplot(data = ecp_cl, mapping = aes(x = cluster, y = Percent_Rural)) +
  geom_boxplot() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Rural Percent by Cluster")
# stacked bar chart of region in each cluster 
ecp_cl %>%
  filter(!(is.na(region))) %>%
  ggplot(aes(cluster)) + 
  geom_bar(aes(fill=region), position="fill") + 
  scale_color_brewer(palette = "Spectral") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Regions by Cluster")
```

AR To Do:

* top 20 overall counties and then color by region + top 5/10 faceted by region -- metric is avg eviction filing rate
* eda for each cluster of all the averages -- i.e. pct white, population/pop. growth, rent burden, income, etc. 
* write out code for the shiny app to incorporate filters and crap into kmeans
* write out code to select similar counties from clusters based on selected county for shiny app 
* rewrite my line graph code to be more dynamic (i.e. have the ability to filter down to state-level top and bottom filing rates)
* start bones of presentation if A) someone already hasn't or B) someone else doesn't have their heart set on it
  * include gganimate in presentation (screen record)
